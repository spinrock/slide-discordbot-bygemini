---
theme: default
title: Try Gemini CLI ~ Trello-Discord Bot ~
class: text-center
transition: slide-left
mdc: true
---

# Gemini CLI を利用したDiscord Bot開発
 
---

# モチベーション

<br />

- Gemini CLI(というか、コーディングエージェントで)開発をやってみたい
  - 既存コードの一部改修や機能追加はしていたが、ゼロから作った時の雰囲気を体験してみたかった
- ちょうどTrelloからDiscordへの連携Botを作ろうと思っていたので、これをテーマにお試ししてみました
- せっかくなので「こんな雰囲気なんだ」がわかったらいいなと持って紹介します

---

# Gemini CLIとは

<br />

Gemini CLIは、Google Cloudが発表した新しいオープンソースのコマンドラインツールです。  
これにより、開発者はターミナルから直接、GoogleのAIモデルであるGeminiの機能を利用できます。

### 主な特徴:
- 多機能性: コーディング支援、コンテンツ作成、問題解決など、幅広いタスクに対応します。
- Gemini Code Assistとの連携: GoogleのAIコーディングアシスタント「Gemini Code Assist」と統合されており、より高度な開発支援が可能です。
- 無料での利用: 個人のGoogleアカウントでログインすれば、無料で利用を開始できます。
- オープンソース: ソースコードが公開されているため、誰でも自由にコードを閲覧・改善でき、特定のニーズに合わせてカスタマイズすることが可能です。

参考: [Gemini CLI : オープンソース AI エージェント | Google Cloud 公式ブログ](https://cloud.google.com/blog/ja/topics/developers-practitioners/introducing-gemini-cli/)

---

# 今回実現したいもののざっくり要件

- Trelloのカードを操作した時に、Discordの特定チャネルに通知をして欲しい。
- 現状、通知して欲しい操作は以下2つ。
  - カードの作成
  - カードのアーカイブ
- 通知する時には、以下情報を含めて欲しい。
  - 操作ユーザ名
  - 操作対象ボード名/カード名/リスト名
  - 操作内容(カードの作成/アーカイブ)

---

# まずは、どんなふうに実現できるかをお伺いしてみる
聞き方は雑です。もっと細かく聞いてもいいかもしれません。

```
% gemini

 ███            █████████  ██████████ ██████   ██████ █████ ██████   █████ █████
░░░███         ███░░░░░███░░███░░░░░█░░██████ ██████ ░░███ ░░██████ ░░███ ░░███
  ░░░███      ███     ░░░  ░███  █ ░  ░███░█████░███  ░███  ░███░███ ░███  ░███
    ░░░███   ░███          ░██████    ░███░░███ ░███  ░███  ░███░░███░███  ░███
     ███░    ░███    █████ ░███░░█    ░███ ░░░  ░███  ░███  ░███ ░░██████  ░███
   ███░      ░░███  ░░███  ░███ ░   █ ░███      ░███  ░███  ░███  ░░█████  ░███
 ███░         ░░█████████  ██████████ █████     █████ █████ █████  ░░█████ █████
░░░            ░░░░░░░░░  ░░░░░░░░░░ ░░░░░     ░░░░░ ░░░░░ ░░░░░    ░░░░░ ░░░░░


Tips for getting started:
1. Ask questions, edit files, or run commands.
2. Be specific for the best results.
3. /help for more information.

Using 1 GEMINI.md file
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ > Trelloにカードを追加した時にDiscordに通知が送れるようにしたいです。アーキテクチャを検討してください。                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
```

<!--
GEMINI.mdの中身は1行だけ

- 日本語で回答してください。
-->

---

# お伺い結果

めっちゃ長いのでざっくり省略

### パターン1 : サーバーレス関数を利用する方法
- 処理の流れ: Trello (Webhook)  ->  サーバーレス関数  ->  Discord (Webhook)
- メリット: 柔軟性、低コスト、サーバー管理不要
- デメリット: コーディングやクラウドに関する知識が必要

<br />

### パターン2 : 外部連携ツールを利用する方法
- 処理の流れ:   Trello  ->  Zapier / IFTTT  ->  Discord
- メリット: 簡単・迅速、多くのサービスに対応
- デメリット: 柔軟性の制限、コスト

---

# 今回はパターン1を選択
### **パターン1 : サーバーレス関数を利用する方法**
- メリット: 柔軟性、低コスト、サーバー管理不要.   
  ⇨ コストが低いのはありがたい。
- デメリット: コーディングやクラウドに関する知識が必要.   
  ⇨ これからGeminiさんと頑張るのでデメリットに感じない。むしろコーディングしてみて欲しい。

<br />

#### パターン2 : 外部連携ツールを利用する方法
- メリット: 簡単・迅速、多くのサービスに対応.   
  ⇨ 多くのサービスに対応している必要は、(少なくとも)今はない
  
- デメリット: 柔軟性の制限、コスト.   
  ⇨ なるべくコストはかけたくない

---
layout: two-cols-header
---

# 具体的な手順のお伺い

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ > 具体的な手順を教えてください。                                                                         │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

✦ 承知いたしました。サーバーレス関数を利用した連携の具体的な手順をご案内します。
```

::left::

以下レスポンスサマリ

1. DiscordでWebhook URLを取得する

2. TrelloのAPIキーとトークンを取得する

3. サーバーレス関数を作成・デプロイする

4. TrelloでWebhookを設定する

::right::

各ステップのレスポンスイメージ

```
ステップ1: DiscordでWebhook URLを取得する

まず、通知を送信したいDiscordチャンネルのWebhook URLを取得します。

  1. 通知を送りたいDiscordサーバーを開き、
     チャンネルの右側にある歯車アイコン 「チャンネルの編集」 をクリックします。
  2. 左のメニューから 「連携」 を選択します。
  3. 「ウェブフックを作成」 ボタンをクリックします。
    （すでに他のウェブフックがある場合は「ウェブフック」ボタンかもしれません）
  4. 作成されたウェブフックの名前（例: Trello通知）を設定し、
    「ウェブフックURLをコピー」 をクリックします。

このURLは後で使いますので、安全な場所に保管しておいてください。
```

---
layout: two-cols-header
---

# ステップ1: DiscordでWebhook URLを取得する

```
まず、通知を送信したいDiscordチャンネルのWebhook URLを取得します。

  1. 通知を送りたいDiscordサーバーを開き、チャンネルの右側にある歯車アイコン 「チャンネルの編集」 をクリックします。
  2. 左のメニューから 「連携」 を選択します。
  3. 「ウェブフックを作成」 ボタンをクリックします。
    （すでに他のウェブフックがある場合は「ウェブフック」ボタンかもしれません）
  4. 作成されたウェブフックの名前（例: Trello通知）を設定し、「ウェブフックURLをコピー」 をクリックします。

このURLは後で使いますので、安全な場所に保管しておいてください。
```

::left::

項目1を選択するところ

<img src='/discord_channel.png' width=320 />

::right::

項目2~4の部分
※実際は「連携」ではなく「連携サービス」でしたがそれくらいの違い?

<img src='/discord_webhook.png'>

---
layout: two-cols-header
---

# ステップ2: TrelloのAPIキーとトークンを取得する

```
次に、TrelloのAPIを利用するために必要なキーとトークンを取得します。

  1. Trelloにログインした状態で、こちらのURLにアクセスしてください: https://trello.com/app-key (https://trello.com/app-key)
  2. 「キー」 (Key) が表示されます。これがAPIキーです。
  3. 同じページにある 「トークン」 (Token) というリンクをクリックし、表示される画面で 「許可」 (Allow) をクリックします。
  4. 表示された英数字の羅列がトークンです。

これらAPIキーとトークンも後ほど使用します。
```

これはちょっと違った様子(Adminポータルが新しくできたらしい)
<div class="flex ml-30">
  <img class="mr-10" src="/trello-api-key.png" width=240 />

  <br />
  =>

  <img class="ml-10" src="/trello-admin-portal.png" width=240 />
</div>

---

# ステップ2: TrelloのAPIキーとトークンを取得する

<br />
こういうところは仕方ないので、素直にググって取得。

<img class="ml-30" src='/public/get-trello-api-key.png' width=600 />

参考サイト: [Trello API KeyとTokenの取得 - Qiita](https://qiita.com/HiguchiTakahiro/items/94f52eee07d257f8f995)

---
layout: two-cols-header
---

# ステップ3: サーバーレス関数を作成・デプロイする

```
Trelloからの情報を受け取り、Discordへ送信するプログラムを作成します。
ここでは、比較的簡単にデプロイできるVercelやNetlify、Cloudflare Workersなどを利用することを想定しています。

(TypeScriptのソースの提示など)
```

Gemini CLIさんからは上記コメントをいただいたのですが、今回はLambdaとPythonでやって欲しかったので、個別にディレクトリ構成を準備してお願いすることにしました。

::left::

以下ディレクトリ構成
```
<root>
  |- <iac>.    : Terraformソース用ディレクトリ
  |- <src>     : Pythonソース用ディレクトリ
  |- GEMINI.md : カスタム命令ファイル
  |- README.md
```

::right::

GEMINI.mdの中身

```
- 日本語で回答してください。
- 技術スタックは以下を想定しています。
  - IaC : Terraform
  - アプリケーション : Python
- ディレクトリ構成は以下を想定しています。
  - src : Pythonソース格納先
  - iac : Terraformソース格納先
- iacソースコードを変更した場合は、以下コマンドを実行して
  問題なく動作することを確認してください。
  - `terraform fmt`
  - `terraform plan`
```

---

# ステップ3: サーバーレス関数を作成・デプロイする(Terraform)
ということで、改めてお願いしてみました。

```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ > Pythonの3.13がデプロイできるLambdaリソースをTerraformで実装してください。Lambda Function URLの有効化も必要です。                                                                         │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

✦ 承知いたしました。Python 3.13ランタイムを使用し、Function URLが有効化されたAWS LambdaリソースをTerraformで実装しますね。

まず、プロジェクトのディレクトリ構造を確認します。

✦ 承知いたしました。iac と src ディレクトリは空のようですので、これからLambda関数用のPythonコードと、それをデプロイするためのTerraformコードを作成します。

最初に、src ディレクトリにLambda関数のソースコードを作成します。
.
.
.
これで、Python 3.13ランタイムを使用し、Function URLが有効化されたLambdaリソースをTerraformで実装できました。

iacディレクトリでterraform applyを実行すると、AWS上にリソースが作成されます。

```

※ 表現の都合上、途中は省略しています。

---

# ステップ3: サーバーレス関数を作成・デプロイする(Terraform)
出来上がったTerraformソースがこちら

![IaC-Source](/public/IaC-Source.png)

※ スライド用に生成しなおしたソースです。実際のものとは異なります。

---

# ステップ3: サーバーレス関数を作成・デプロイする
ログをあまりきちんと残していなかったので初手の部分だけ...
```
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ > Discordにメッセージを投げるLambdaアプリをPythonで実装してください。Discord接続URLは環境変数で渡されるものとしてください。   
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
```
出来上がったPythonソースがこちら

<img src='/public/App-Source.png' width=720/>

---

# ステップ4: TrelloでWebhookを設定する

```
  最後に、Trelloボードのアクティビティを、先ほどデプロイした関数のURLに送信するように設定します。

  これはTrelloのAPIを使って行います。以下の curl コマンドをターミナルで実行してください。

  実行するコマンド:(略)

  このコマンドが成功すると、Trelloボードで新しいカードが作成されるたびに、指定したDiscordチャンネルに通知が届くようになります。
```

curlコマンドも提示いただいたのですが、諸々動作確認もしていたので、Postmanで実行しました。

<img class="ml-50" src="/postman_image.png" width=450/>

---

# 動作確認
実際にカードの追加/アーカイブをした時の通知を見てみます。

カードの追加 ⇨ Discordの通知時のイメージです。  
※アーカイブも実施したので、その通知も飛んでいます。


<div class="flex ml-30">
  <img class="mr-10" src="/trello_add_card.png" width=240 />

  <br />
  =>

  <img class="ml-10" src="/discord_notification.png" width=400 />
</div>

---

# 感想

### Gemini CLIを用いたDiscord Bot作成

- 今回Gemini CLIを利用していい感じに開発してくれました
  - 所要時間: 諸々全部で2~3時間くらいでした(Terraform実行環境は事前にありました)
    - 途中トラシューやらTrello APIのレスポンスと試行錯誤する時間(手作業含む)が結構かかった.   
      (もっといい感じに使えたらもっと短縮できたかもしれない)
  - 割といい感じにコード生成してくれたので、大枠の部分で突っ込むことはほとんどなかった
- 「とりあえず動けば/表示できれば良い」の精神で開発したので、ちゃんと使うためには以下テスト周りもきちんと整備したいと思いました。

<br />

#### ※ (おまけ) Slidevによるスライド作成

- 慣れは必要だが、個人的には悪くない印象でした
- ホットリロード機能(ブラウザ側で表示しながらの編集)はあまり期待しない方が良さそう